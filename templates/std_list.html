<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enrolled Students</title>
    <link rel="stylesheet" href="/static/std_list.css">
    <style>
        td span {
            font-size: 1.2rem;
            cursor: default;
        }

        td span[title] {
            border-bottom: 1px dotted #999;
        }
    </style>
</head>

<body>
    <header>
        <h1>Department of Computer & Information Sciences</h1>
    </header>
    <div class="container">
        <h2 class="course-title"></h2>
        <h3>Enrolled Students</h3>
        <table id="students-table">
            <thead>
                <tr>
                    <th>Student ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <!-- Lab headers will be inserted here -->
                </tr>
            </thead>
            <tbody>
                <!-- Student rows will be inserted here -->
            </tbody>
        </table>
    </div>

    <script>
        const courseCode = window.location.pathname.split("/")[2];  // e.g., /teacher/students/<course_code>



        async function fetchStudents() {
            const res = await fetch(`/api/teacher/students/${courseCode}`);
            const data = await res.json();
            if (!data.success) {
                alert("Failed to load students.");
                return;
            }

            const students = data.students;
            if (students.length === 0) return;

            // Group by student
            const grouped = {};
            const labSet = new Set();
            students.forEach(entry => {
                if (!grouped[entry.ROLL_NO]) {
                    grouped[entry.ROLL_NO] = {
                        name: entry.STUDENT_NAME,
                        email: entry.EMAIL,
                        labs: {}
                    };
                }
                grouped[entry.ROLL_NO].labs[entry.LAB_NO] = entry.SUBMISSION_STATUS;
                labSet.add(entry.LAB_NO);
            });

            const sortedLabs = Array.from(labSet).sort((a, b) => a - b);

            // Add lab columns to header
            const headerRow = document.querySelector("#students-table thead tr");
            sortedLabs.forEach(labNo => {
                const th = document.createElement("th");
                th.textContent = `Lab ${labNo}`;
                headerRow.appendChild(th);
            });

            const tbody = document.querySelector("#students-table tbody");

            Object.entries(grouped).forEach(([roll, data]) => {
                const tr = document.createElement("tr");

                tr.innerHTML = `
                    <td>${roll}</td>
                    <td>${data.name}</td>
                    <td>${data.email}</td>
                `;

                sortedLabs.forEach(labNo => {
                    const status = data.labs[labNo];
                    const td = document.createElement("td");
                    let icon = "❓";
                    let tooltip = "Not submitted";

                    if (status === "Checked") {
                        icon = "✅";
                        tooltip = "Marked correct";
                    } else if (status === "Submitted") {
                        icon = "☑️";
                        tooltip = "Pending review";
                    }

                    td.innerHTML = `<span title="${tooltip}">${icon}</span>`;
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
        }

        async function loadCourseTitle() {
            try {
                const response = await fetch(`/api/course_name/${courseCode}`);
                const data = await response.json();

                if (data.success) {
                    document.querySelector(".course-title").textContent = data.course_name;
                    document.title = `Options - ${data.course_name}`;
                } else {
                    document.querySelector(".course-title").textContent = "Course Not Found";
                }
            } catch (err) {
                document.querySelector(".course-title").textContent = "Error loading course";
            }
        }

        loadCourseTitle();
        fetchStudents();
    </script>
</body>

</html>